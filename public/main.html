<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{APP_NAME}}</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div class="app">
      <header class="panel">
        <div class="title-wrap">
          <h1 class="title-main">{{APP_CHAT_TITLE}}</h1>
          <p class="title-sub">{{APP_CONSOLE_LABEL}}</p>
        </div>
        <div class="top-actions">
          <span id="clock"></span>
          <button id="logoutBtn" class="btn btn-secondary" type="button">logout</button>
        </div>
      </header>
      <section id="chatLog" class="panel"></section>
      <form id="chatForm" class="panel">
        <textarea id="input" placeholder="Type your message..."></textarea>
        <div class="form-row">
          <button id="sendBtn" class="btn btn-primary" type="submit">Send</button>
          <span id="status"></span>
        </div>
      </form>
    </div>

    <script>
      const chatLog = document.getElementById("chatLog");
      const chatForm = document.getElementById("chatForm");
      const input = document.getElementById("input");
      const sendBtn = document.getElementById("sendBtn");
      const statusEl = document.getElementById("status");
      const clock = document.getElementById("clock");
      const logoutBtn = document.getElementById("logoutBtn");

      function render(messages) {
        chatLog.innerHTML = "";
        for (const m of messages) {
          const wrap = document.createElement("div");
          wrap.className = `msg ${m.role === "user" ? "user" : "assistant"}`;
          const role = document.createElement("div");
          role.className = "role";
          role.textContent = `${m.role} â€¢ ${new Date(m.timestamp).toLocaleString()}`;
          const body = document.createElement("div");
          body.className = "bubble";
          body.textContent = m.content;
          wrap.appendChild(role);
          wrap.appendChild(body);
          chatLog.appendChild(wrap);
        }
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      async function loadHistory() {
        const res = await fetch("/api/chat/history");
        if (res.status === 401) {
          location.href = "/";
          return;
        }
        if (!res.ok) {
          statusEl.textContent = "Failed to load history";
          return;
        }
        const data = await res.json();
        render(data.messages || []);
        setBusy(Boolean(data.isBusy));
      }

      function setBusy(isBusy) {
        sendBtn.disabled = isBusy;
        statusEl.textContent = isBusy ? "Your request is being processed..." : "";
      }

      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const content = input.value.trim();
        if (!content) return;

        setBusy(true);
        statusEl.textContent = "Sending...";

        try {
          const res = await fetch("/api/chat/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content })
          });

          if (res.status === 401) {
            location.href = "/";
            return;
          }

          const data = await res.json();

          if (!res.ok) {
            statusEl.textContent = data.error || "Request failed";
            await loadHistory();
            return;
          }

          input.value = "";
          statusEl.textContent = "";
          await loadHistory();
        } catch (_err) {
          statusEl.textContent = "Network error";
          await loadHistory();
        }
      });

      logoutBtn.addEventListener("click", async () => {
        try {
          await fetch("/api/auth/logout", { method: "POST" });
        } finally {
          location.href = "/";
        }
      });

      function tickClock() {
        clock.textContent = new Date().toLocaleTimeString();
      }

      setInterval(tickClock, 1000);
      tickClock();
      loadHistory();
    </script>
  </body>
</html>
